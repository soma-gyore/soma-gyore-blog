<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Breached password detection a.k.a. binary search and indexing in action - Soma Gyore's blog</title><meta name=Description content><meta property="og:title" content="Breached password detection a.k.a. binary search and indexing in action"><meta property="og:description" content="Introduction According to an Online Security Survey conducted by Google/Harris Poll
 52% of the people reuse the same password for multiple accounts and 13% of them reuse the same password for all of their accounts.  This doesn&rsquo;t look so good. There&rsquo;s a great chance that the user credentials leaked from &lsquo;site A&rsquo; will also leave the door open for attackers at &lsquo;site B&rsquo;.
You can protect your users from loosing control over multiple accounts by checking their passwords:"><meta property="og:type" content="article"><meta property="og:url" content="https://soma-gyore.github.io/soma-gyore-blog/posts/breached-password/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-09T20:38:38+02:00"><meta property="article:modified_time" content="2022-04-09T20:38:38+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Breached password detection a.k.a. binary search and indexing in action"><meta name=twitter:description content="Introduction According to an Online Security Survey conducted by Google/Harris Poll
 52% of the people reuse the same password for multiple accounts and 13% of them reuse the same password for all of their accounts.  This doesn&rsquo;t look so good. There&rsquo;s a great chance that the user credentials leaked from &lsquo;site A&rsquo; will also leave the door open for attackers at &lsquo;site B&rsquo;.
You can protect your users from loosing control over multiple accounts by checking their passwords:"><meta name=application-name content="Soma Gyore's blog"><meta name=apple-mobile-web-app-title content="Soma Gyore's blog"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://soma-gyore.github.io/soma-gyore-blog/posts/breached-password/><link rel=stylesheet href=/soma-gyore-blog/lib/normalize/normalize.min.css><link rel=stylesheet href=/soma-gyore-blog/css/style.min.css><link rel=stylesheet href=/soma-gyore-blog/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/soma-gyore-blog/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Breached password detection a.k.a. binary search and indexing in action","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/soma-gyore.github.io\/soma-gyore-blog\/posts\/breached-password\/"},"genre":"posts","wordcount":1448,"url":"https:\/\/soma-gyore.github.io\/soma-gyore-blog\/posts\/breached-password\/","datePublished":"2022-04-09T20:38:38+02:00","dateModified":"2022-04-09T20:38:38+02:00","publisher":{"@type":"Organization","name":"Author"},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":''==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:''==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/soma-gyore-blog/ title="Soma Gyore's blog">Soma Gyore's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/soma-gyore-blog/soma-gyore-blog/posts/>Posts </a><a class=menu-item href=/soma-gyore-blog/soma-gyore-blog/tags/>Tags </a><a class=menu-item href=/soma-gyore-blog/soma-gyore-blog/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/soma-gyore-blog/ title="Soma Gyore's blog">Soma Gyore's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/soma-gyore-blog/soma-gyore-blog/posts/ title>Posts</a><a class=menu-item href=/soma-gyore-blog/soma-gyore-blog/tags/ title>Tags</a><a class=menu-item href=/soma-gyore-blog/soma-gyore-blog/categories/ title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Breached password detection a.k.a. binary search and indexing in action</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/soma-gyore-blog/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-04-09>2022-04-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1448 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#linear-search---too-slow-too-much-resource-usage>Linear search - too slow, too much resource usage</a></li><li><a href=#binary-search>Binary search</a><ul><li><a href=#processing-our-data>Processing our data</a></li><li><a href=#converting-the-db>Converting the DB</a></li><li><a href=#indexing>Indexing</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=introduction>Introduction</h1><p>According to an <a href=https://services.google.com/fh/files/blogs/google_security_infographic.pdf target=_blank rel="noopener noreffer">Online Security Survey</a> <em>conducted by Google/Harris Poll</em></p><ul><li>52% of the people reuse the same password for multiple accounts and</li><li>13% of them reuse the same password for <strong>all</strong> of their accounts.</li></ul><p>This doesn&rsquo;t look so good. There&rsquo;s a great chance that the user credentials leaked from &lsquo;site A&rsquo; will also leave the door open for attackers at &lsquo;site B&rsquo;.</p><p>You can protect your users from loosing control over multiple accounts by checking their passwords:</p><ul><li><strong>at login:</strong> notify them (or even block them) if their existing password was part of a data breach</li><li><strong>at registration:</strong> do not allow the use of a breached password.</li></ul><p>Good thing there&rsquo;s a database known to humankind as <a href=https://haveibeenpwned.com/Passwords target=_blank rel="noopener noreffer">haveibeenpwned (HIBP)</a> to lend you a helping hand.</p><p>The database is a text file that contains the leaked passwords hashes followed by the exact count of how many times that password was seen in the source data breaches.</p><p>HIBP provides an <a href=https://haveibeenpwned.com/API/v3 target=_blank rel="noopener noreffer">API</a> but here&rsquo;s the thing: it has a rate limit of one request per 1500 milliseconds. This means it isn&rsquo;t suitable for using it in production.</p><p>Yet, there is way, and this article is all about me showing you that way.</p><p>Note*: There are multiple versions of the database and we&rsquo;re going to use the version that&rsquo;s ordered by hash. We&rsquo;ll discuss the <em>why</em> later.</p><h1 id=the-problem>The problem</h1><p>So, our task is to decide whether the breached password database contains the SHA1 hash of the given password as fast as possible with as low resource usage as possible.</p><p>The size of the HIBP breached password database is more than 36GB as of the writing this article (v8).</p><h1 id=the-solution>The solution</h1><h2 id=linear-search---too-slow-too-much-resource-usage>Linear search - too slow, too much resource usage</h2><p>Linear search is the easiest solution to implement: you go through the file, line by line, and compare each line with the given hash. If there is a match: the password has been compromised. If we make it till the end of the whole file without any match then the password wasn&rsquo;t breached.</p><p>The biggest problem with this approach is that it uses lots of CPU and it runs for minutes. Especially if we assume that most of the users&rsquo; passwords are not compromised (so the search will query through the whole file most of the time).</p><h2 id=binary-search>Binary search</h2><p>As I promised earlier, I&rsquo;m going to explain the <em>why</em> about choosing the version of the breached password DB that&rsquo;s ordered by hash.</p><p>As Wikipedia says:</p><blockquote><p>Binary search [&mldr;] is a search algorithm that finds the position of a target value within a sorted array.</p><p>&mdash; <a href=https://en.wikipedia.org/wiki/Binary_search_algorithm target=_blank rel="noopener noreffer">Binary search algorithm. (2022, April 10). In Wikipedia, The Free Encyclopedia. Retrieved 11:57, April 10, 2022</a></p></blockquote><p>We have a sorted &ldquo;array&rdquo; (that&rsquo;s actually a sorted text file) so it seems we can make good use of this algorithm to solve all of our performance problems.</p><p>There&rsquo;s more: our dataset has another property that we could take advantage of: <strong>every hash has the same length!</strong> (20 byte/40 characters because it&rsquo;s SHA1)</p><h3 id=processing-our-data>Processing our data</h3><p>First, we have to get our raw file in shape to suit our needs.</p><p>The database looks like this:</p><pre tabindex=0><code>000000005AD76BD555C1D6D771DE417A4B87E4B4:10
00000000A8DAE4228F821FB418F59826079BF368:4
00000000DD7F2A1C68A35673713783CA390C9E93:873
00000001E225B908BAC31C56DB04D892E47536E0:6
...
</code></pre><h4 id=removing-unnecessary-characters>Removing unnecessary characters</h4><p>We don&rsquo;t need the information on the number of occurrences. We can also remove the new lines so we can use position seeking (remember: hashes are the same length).</p><p>After processing, our data file will look a lot like this:</p><pre tabindex=0><code>000000005AD76BD555C1D6D771DE417A4B87E4B400000000A8DAE4228F821FB418F59826079BF368...
</code></pre><p>Basically, we have one line and every 40 characters is a hash.</p><p>We&rsquo;re getting there, but we can still optimize our processed file.</p><h4 id=store-as-a-binary-data>Store as a binary data</h4><p>We can store the file as <strong>binary data!</strong> The file size will be cut in half compared to the size of the raw text version.</p><p>After processing, we get a ~16GB file. That&rsquo;s much better!</p><h3 id=converting-the-db>Converting the DB</h3><p>So our converter script will look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>raw_pwned_passwords_file</span> <span class=o>=</span> <span class=s2>&#34;pwned-passwords-sha1-ordered-by-hash-v8.txt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;out.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>binary_file</span><span class=p>:</span> <span class=c1># open the output file to writing a binary file </span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>raw_pwned_passwords_file</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>raw_file</span><span class=p>:</span> <span class=c1># open the raw database file for reading</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>raw_file</span><span class=p>:</span> <span class=c1># go through every line</span>
</span></span><span class=line><span class=cl>            <span class=n>binary_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>line</span><span class=p>[:</span><span class=mi>40</span><span class=p>]))</span> <span class=c1># write the first 40 characters of the line as binary data</span>
</span></span></code></pre></div><p>It&rsquo;ll take a while to process the whole database but after it&rsquo;s done the size will be significantly smaller!</p><p>We shrank our database by more than half so it&rsquo;s definitely progress!</p><p>The binary search algorithm:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>searched_string</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>searched_hash</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha1</span><span class=p>(</span><span class=n>searched_string</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span> <span class=c1># create a hash from the searched password</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>processed_db_file_path</span> <span class=o>=</span> <span class=s2>&#34;out.txt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>file_size</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getsize</span><span class=p>(</span><span class=n>processed_db_file_path</span><span class=p>)</span> <span class=c1># get the size of the password db</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>processed_db_file_path</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span> <span class=c1># open the processed breached pw db file</span>
</span></span><span class=line><span class=cl>    <span class=n>low</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>high</span> <span class=o>=</span> <span class=n>file_size</span><span class=o>//</span><span class=mi>20</span> <span class=c1># we have file_size/20 hash in the file</span>
</span></span><span class=line><span class=cl>    <span class=n>mid</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>low</span> <span class=o>&lt;=</span> <span class=n>high</span><span class=p>:</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=n>mid</span> <span class=o>=</span> <span class=p>(</span><span class=n>high</span> <span class=o>+</span> <span class=n>low</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=n>file</span><span class=o>.</span><span class=n>seek</span><span class=p>(</span><span class=n>mid</span><span class=o>*</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>current_hash</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_hash</span> <span class=o>&lt;</span> <span class=n>searched_hash</span><span class=p>:</span> <span class=c1># searched_hash is greater, ignore left half</span>
</span></span><span class=line><span class=cl>            <span class=n>low</span> <span class=o>=</span> <span class=n>mid</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>current_hash</span> <span class=o>&gt;</span> <span class=n>searched_hash</span><span class=p>:</span> <span class=c1># searched_hash is smaller, ignore right half</span>
</span></span><span class=line><span class=cl>            <span class=n>high</span> <span class=o>=</span> <span class=n>mid</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span> <span class=c1># searched_hash is present at mid</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;not found&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Much faster than the linear search.</p><p>Don&rsquo;t sit back just yet&mldr; we can take this a little further.</p><h3 id=indexing>Indexing</h3><p><em>So what if</em> during DB conversion we create an index file for our hashes.</p><p>We&rsquo;ll work with the first n bytes of the hashes. We&rsquo;ll store the information where the hashes start, for example: hashes starting with &lsquo;01&rsquo; start from 100 bytes in the database file, hashes starting with &lsquo;02&rsquo; start from 250 bytes, etc.</p><p>Then we read this index file into a variable. Thanks to this file, we need to check only a small range which means fewer I/O operations.</p><p>However, we need to choose carefully our index size (hash prefix).
There are 2 things to take into cosideration:</p><ol><li><p>The DB should contain every possible hash prefix.
For example, if we use a 3-byte index then we have to make sure that our DB contains every possibility of the hash prefixes for the first 3 bytes/6 characters. So everything from <em>000000</em> to <em>FFFFFF</em>.
We can check this with the following command:</p><pre tabindex=0><code>cat pwned-passwords-sha1-ordered-by-hash-v8.txt | colrm 7 | uniq | wc -l
</code></pre><p>the output of this command is</p><pre tabindex=0><code>16777216
</code></pre><p>so it means that we have all of the hash prefixes from <em>000000</em> to <em>FFFFFF</em> (because it&rsquo;s 16^6 variations so 16777216)</p></li><li><p>How many memory we can use?</p><ul><li>2-byte indexes use 16^4*8 byte, so ~65KB</li><li>3-byte indexes use 16^6*8 byte so ~134MB</li><li>4-byte indexes use 16^8*8 byte, so ~34 GB</li></ul></li></ol><p>A 4-byte index is not reasonable, so 2 or 3 bytes will be the best choice.</p><p>Let&rsquo;s choose 3 bytes for our implementation and improve our DB generating script with index file generation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>raw_pwned_passwords_file</span> <span class=o>=</span> <span class=s2>&#34;pwned-passwords-sha1-ordered-by-hash-v8.txt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prev_line</span> <span class=o>=</span> <span class=s2>&#34;000000&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;out.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;wb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>binary_file</span><span class=p>:</span> <span class=c1># open hash output file for write as a binary file</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;index.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>index_file</span><span class=p>:</span> <span class=c1># open index file to write as a regular file</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>raw_pwned_passwords_file</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>raw_file</span><span class=p>:</span> <span class=c1># open raw file for reading</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>raw_file</span><span class=p>:</span> <span class=c1># read the raw file line by line</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>line</span><span class=p>[:</span><span class=mi>6</span><span class=p>]</span> <span class=o>!=</span> <span class=n>prev_line</span><span class=p>:</span> <span class=c1># if there is a difference between the first 3 bytes then</span>
</span></span><span class=line><span class=cl>                    <span class=n>index_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>binary_file</span><span class=o>.</span><span class=n>tell</span><span class=p>())</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span> <span class=c1># write the position to the index file</span>
</span></span><span class=line><span class=cl>                    <span class=n>prev_line</span> <span class=o>=</span> <span class=n>line</span><span class=p>[:</span><span class=mi>6</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>binary_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=nb>bytes</span><span class=o>.</span><span class=n>fromhex</span><span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>6</span><span class=p>:</span><span class=mi>40</span><span class=p>]))</span> <span class=c1># write the hash from 6th character to 40th</span>
</span></span></code></pre></div><p>We have 2 files:</p><ul><li>one that contains the hashes</li><li>one that has the positions where our hashes starts based on the first 3 bytes.</li></ul><p>We can cut the first 3 bytes off of the hashes because we already know where to look when we search for a hash.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>searched_string</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>searched_hash</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha1</span><span class=p>(</span><span class=n>searched_string</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;searched password SHA1 hash: &#34;</span> <span class=o>+</span> <span class=n>searched_hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>processed_db_file_path</span> <span class=o>=</span> <span class=s2>&#34;out.txt&#34;</span>
</span></span><span class=line><span class=cl><span class=n>index_file_path</span> <span class=o>=</span> <span class=s2>&#34;index.txt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>file_size</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getsize</span><span class=p>(</span><span class=n>processed_db_file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>indexes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>index_file_path</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>index_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>indexes</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>int</span><span class=p>,</span> <span class=n>index_file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>splitlines</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>processed_db_file_path</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>hash_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>     <span class=c1># the first 3 bytes of the hash represents the index of the indexes</span>
</span></span><span class=line><span class=cl>     <span class=c1># i.e. if the searched hash starts with &#39;000012&#39; then we need the 18th position</span>
</span></span><span class=line><span class=cl>    <span class=n>low</span> <span class=o>=</span> <span class=n>indexes</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>searched_hash</span><span class=p>[:</span><span class=mi>6</span><span class=p>],</span> <span class=mi>16</span><span class=p>)]</span> <span class=o>//</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># max position is always n+1</span>
</span></span><span class=line><span class=cl>    <span class=n>high</span> <span class=o>=</span> <span class=n>indexes</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>searched_hash</span><span class=p>[:</span><span class=mi>6</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>//</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>    <span class=n>mid</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>low</span> <span class=o>&lt;=</span> <span class=n>high</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mid</span> <span class=o>=</span> <span class=p>(</span><span class=n>high</span> <span class=o>+</span> <span class=n>low</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>hash_file</span><span class=o>.</span><span class=n>seek</span><span class=p>(</span><span class=n>mid</span><span class=o>*</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>hash</span> <span class=o>=</span> <span class=n>hash_file</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>hash</span> <span class=o>&lt;</span> <span class=n>searched_hash</span><span class=p>[</span><span class=mi>6</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>            <span class=n>low</span> <span class=o>=</span> <span class=n>mid</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>hash</span> <span class=o>&gt;</span> <span class=n>searched_hash</span><span class=p>[</span><span class=mi>6</span><span class=p>:]:</span>
</span></span><span class=line><span class=cl>            <span class=n>high</span> <span class=o>=</span> <span class=n>mid</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;not found&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h1 id=conclusion>Conclusion</h1><p>If you want to implement breached password detection for your application and you don&rsquo;t want to rely on Have I been pwned API or their rate limit is too strict for your use case, this solution can be a viable option for your application.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-04-09</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/soma-gyore-blog/>Home</a></span></section></div><div class=post-nav></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.97.3">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/soma-gyore-blog/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/soma-gyore-blog/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/soma-gyore-blog/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/soma-gyore-blog/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{}}</script><script type=text/javascript src=/soma-gyore-blog/js/theme.min.js></script></body></html>